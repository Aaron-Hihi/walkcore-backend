generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * ENUMS
 * =========================
 */
enum Gender {
  MALE
  FEMALE
}

enum SessionMode {
  SOLO
  REMOTE
}

enum SessionStatus {
  PLANNED
  ONGOING
  FINISHED
  CANCELLED
}

enum Visibility {
  PUBLIC
  FRIENDONLY
  INVITEONLY
}

enum ParticipantStatus {
  JOINED
  LEFT
  FINISHED
}

enum FriendStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

enum RequirementType {
  TOTAL_STEPS
  TOTAL_DISTANCE
  TOTAL_CALORIES
  TOTAL_SESSIONS
  LONGEST_STREAK
}

enum ItemType {
  AVATAR
  FRAME
  BACKGROUND
  CONSUMABLE
}

enum NotificationType {
  FRIEND_REQUEST
  FRIEND_ACCEPTED
  ACHIEVEMENT_UNLOCKED
  SESSION_INVITE
  SYSTEM_ANNOUNCEMENT
}

/**
 * =========================
 * USER CORE MODEL
 * =========================
 */
model User {
  id           BigInt    @id @default(autoincrement())
  username     String    @unique
  email        String    @unique
  password     String
  tokenVersion Int       @default(0)
  dateOfBirth  DateTime?
  gender       Gender?
  height       Decimal?  @db.Decimal(10, 2)
  weight       Decimal?  @db.Decimal(10, 2)
  currency     Int       @default(0)

  totalSteps          BigInt  @default(0)
  totalDistance       Decimal @default(0) @db.Decimal(10, 2)
  totalActiveTime     Int     @default(0)
  totalSessionTime    Int     @default(0)
  totalSessionCount   Int     @default(0)
  totalCaloriesBurned Int     @default(0)
  longestStreak       Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessionsCreated  Session[]
  participants     SessionParticipant[]
  dailyActivities  UserDailyActivity[]
  userAchievements UserAchievement[]
  userItems        UserItem[]
  notifications    Notification[]

  sentFriendRequests     Friendship[] @relation("Requester")
  receivedFriendRequests Friendship[] @relation("Addressee")
}

/**
 * =========================
 * SOCIAL & FRIEND SYSTEM
 * =========================
 */
model Friendship {
  id           Int          @id @default(autoincrement())
  requesterId  BigInt
  addresseeId  BigInt
  friendStatus FriendStatus
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  requester User @relation("Requester", fields: [requesterId], references: [id])
  addressee User @relation("Addressee", fields: [addresseeId], references: [id])

  @@unique([requesterId, addresseeId])
}

/**
 * =========================
 * ACTIVITY LOGGING
 * =========================
 */
model UserDailyActivity {
  id             BigInt   @id @default(autoincrement())
  userId         BigInt
  date           DateTime @db.Date
  stepsWalked    Int      @default(0)
  distance       Decimal  @default(0) @db.Decimal(10, 2)
  activeTime     Int      @default(0)
  sessionTime    Int      @default(0)
  sessionCount   Int      @default(0)
  caloriesBurned Int      @default(0)
  currencyEarned Int      @default(0)
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@index([date])
}

/**
 * =========================
 * SESSION SYSTEM
 * =========================
 */
model Session {
  id              BigInt        @id @default(autoincrement())
  creatorId       BigInt
  title           String
  description     String?
  mode            SessionMode
  status          SessionStatus @default(PLANNED)
  visibility      Visibility    @default(PUBLIC)
  maxParticipants Int
  stepTarget      Int
  startTime       DateTime
  endTime         DateTime
  startLat        Decimal?      @db.Decimal(10, 7)
  startLong       Decimal?      @db.Decimal(10, 7)

  creator      User                 @relation(fields: [creatorId], references: [id])
  participants SessionParticipant[]
}

model SessionParticipant {
  id             BigInt            @id @default(autoincrement())
  sessionId      BigInt
  userId         BigInt
  status         ParticipantStatus
  isAdmin        Boolean           @default(false)
  stepTarget     Int?
  totalSteps     Int?              @default(0)
  joinTime       DateTime          @default(now())
  leaveTime      DateTime?
  currencyEarned Int?              @default(0)
  caloriesBurned Int?              @default(0)
  approxDistance Decimal?          @db.Decimal(10, 2)

  session Session @relation(fields: [sessionId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([sessionId, userId])
  @@index([totalSteps(sort: Desc)])
}

/**
 * =========================
 * ACHIEVEMENT SYSTEM
 * =========================
 */
model Achievement {
  id               Int               @id @default(autoincrement())
  title            String
  description      String
  requirementType  RequirementType
  requirementValue Int
  reward           Int
  userAchievements UserAchievement[]
}

model UserAchievement {
  id            Int       @id @default(autoincrement())
  userId        BigInt
  achievementId Int
  progress      Int       @default(0)
  isCompleted   Boolean   @default(false)
  completedAt   DateTime?

  user        User        @relation(fields: [userId], references: [id])
  achievement Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
}

/**
 * =========================
 * SHOP & INVENTORY SYSTEM
 * =========================
 */
model ShopItem {
  id          Int        @id @default(autoincrement())
  name        String
  description String
  price       Int
  imageUrl    String?
  itemType    ItemType   @default(AVATAR)
  userItems   UserItem[]
}

model UserItem {
  id          Int      @id @default(autoincrement())
  userId      BigInt
  shopItemId  Int
  quantity    Int      @default(1)
  purchasedAt DateTime @default(now())
  acquiredAt  DateTime @default(now())
  isEquipped  Boolean  @default(false)

  user     User     @relation(fields: [userId], references: [id])
  shopItem ShopItem @relation(fields: [shopItemId], references: [id])

  @@unique([userId, shopItemId])
}

/**
 * =========================
 * NOTIFICATION MODEL
 * =========================
 */
model Notification {
  id        BigInt           @id @default(autoincrement())
  userId    BigInt
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id])
}
